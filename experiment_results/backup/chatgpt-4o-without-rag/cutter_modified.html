<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VTK.js Rotor Visualization</title>
  <script src="https://unpkg.com/vtk.js@34.10.0/vtk.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
    }
    #container {
      height: 100%;
      width: 100%;
      position: relative;
    }
    #orientation {
      position: absolute;
      width: 150px;
      height: 150px;
      bottom: 10px;
      right: 10px;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Orientation marker viewport -->
    <div id="orientation"></div>
  </div>

  <script>
    const vtkGenericRenderWindow = vtk.Rendering.Misc.vtkGenericRenderWindow;
    const vtkHttpDataSetReader = vtk.IO.Core.vtkHttpDataSetReader;
    const vtkImageMapper = vtk.Rendering.Core.vtkImageMapper;;
    const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
    const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
    const vtkDataArray = vtk.Common.Core.vtkDataArray;
    const vtkOrientationMarkerWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget;
    const vtkAxesActor = vtk.Rendering.Core.vtkAxesActor;
    const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
    // ----------------------------------------------------------------------------
    // Create the main render window
    // ----------------------------------------------------------------------------
    const fullScreenRenderer = vtkGenericRenderWindow.newInstance();
    fullScreenRenderer.setContainer(document.getElementById('container'));
    const renderer = fullScreenRenderer.getRenderer();
    const renderWindow = fullScreenRenderer.getRenderWindow();

    // ----------------------------------------------------------------------------
    // Load dataset from URL
    // ----------------------------------------------------------------------------
    const reader = vtkXMLImageDataReader.newInstance();
    reader.setUrl('http://127.0.0.1:5000/dataset/rotor.vti').then(() => {
      reader.loadData().then(() => {
        const imageData = reader.getOutputData();

        // ------------------------------
        // Set active scalar to "Pressure"
        // ------------------------------
        imageData.getPointData().setActiveScalars('Pressure');

        // ------------------------------
        // Get dimensions and compute slice index at 95% along Y axis
        // ------------------------------
        const dims = imageData.getDimensions(); // [x, y, z]
        const yIndex = Math.floor(0.95 * dims[1]); // 95% depth on Y axis

        // ------------------------------
        // Create mapper and set slicing mode
        // ------------------------------
        const mapper = vtkImageMapper.newInstance();
        mapper.setInputData(imageData);
        mapper.setSlicingMode(1);
        mapper.setSlice(yIndex); // Set slice index

        // ------------------------------
        // Create image slice actor
        // ------------------------------
        const slice = vtkImageSlice.newInstance();
        slice.setMapper(mapper);

        // ------------------------------
        // Create and apply color map (blue → white → red)
        // ------------------------------
        const scalars = imageData.getPointData().getScalars();
        const dataRange = scalars.getRange();

        const colorTransferFunction = vtkColorTransferFunction.newInstance();
        colorTransferFunction.addRGBPoint(dataRange[0], 0, 0, 1); // Blue at min
        colorTransferFunction.addRGBPoint((dataRange[0] + dataRange[1]) / 2, 1, 1, 1); // White at mid
        colorTransferFunction.addRGBPoint(dataRange[1], 1, 0, 0); // Red at max

        // ------------------------------
        // Apply color map and full opacity (no transparency)
        // ------------------------------
        slice.getProperty().setRGBTransferFunction(0, colorTransferFunction);
        slice.getProperty().setOpacity(1.0); // Fully opaque
        slice.getProperty().setInterpolationTypeToLinear();

        // ------------------------------
        // Add actor to renderer and render
        // ------------------------------
        renderer.addActor(slice);
        renderer.resetCamera();
        renderWindow.render();

        // ------------------------------
        // Add orientation marker in bottom-right
        // ------------------------------
        const axes = vtkAxesActor.newInstance();
        const orientationWidget = vtkOrientationMarkerWidget.newInstance({
          actor: axes,
          interactor: renderWindow.getInteractor(),
        });
        orientationWidget.setEnabled(true);
        orientationWidget.setViewportCorner(
          vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT
        );
        orientationWidget.setViewportSize(0.2);
        orientationWidget.setMinPixelSize(100);
        orientationWidget.setMaxPixelSize(150);
        orientationWidget.setViewportCorner(
          vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT
        );
        orientationWidget.setEnabled(true);
     });
    });
  </script>
</body>
</html>
