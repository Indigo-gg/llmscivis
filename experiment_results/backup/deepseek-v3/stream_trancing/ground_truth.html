<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Isosurface Rendering for Isabel Dataset</title>
</head>

<body>
<!-- Renderer container -->
<div id="renderer"></div>
<!-- Load VTK.js library -->
<script src="https://unpkg.com/vtk.js"></script>
<script>
// Import required VTK.js classes
const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
const vtkActor = vtk.Rendering.Core.vtkActor;
const vtkMapper = vtk.Rendering.Core.vtkMapper;
const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
const vtkImageMarchingCubes = vtk.Filters.General.vtkImageMarchingCubes;

// Initialize render window, set background color to black
const fullScreenRenderWindow = vtkFullScreenRenderWindow.newInstance({
background: [0.1, 0.1, 0.1],
});
const renderWindow = fullScreenRenderWindow.getRenderWindow();
const renderer = fullScreenRenderWindow.getRenderer();

// Create XML image data reader instance
const reader = vtkXMLImageDataReader.newInstance();

// Set data file URL and load data
reader.setUrl('..\\..\\..\\vtkjs-benchmark-datasets\\isabel.vti').then(() => {
// After data URL is set successfully, load data
reader.loadData().then(() => {
// Get loaded image data
const imageData = reader.getOutputData(0);

// Get velocity vector field from data
const velocityArray = imageData.getPointData().getArrayByName('Velocity');
// Get total number of data points
const numPoints = imageData.getNumberOfPoints();
// Create new array to store velocity magnitude
const magnitudeData = new Float64Array(numPoints);

// Calculate velocity magnitude (norm of velocity vector) for each point
for (let i = 0; i < numPoints; i++) {
// Get three components of velocity
const vx = velocityArray.getData()[3 * i + 0]; // x component
const vy = velocityArray.getData()[3 * i + 1]; // y component
const vz = velocityArray.getData()[3 * i + 2]; // z component
// Calculate velocity magnitude (Euclidean norm)
magnitudeData[i] = Math.sqrt(vx * vx + vy * vy + vz * vz);
}

// Create VTK data array class
const vtkDataArray = vtk.Common.Core.vtkDataArray;
// Create VTK array for velocity magnitude
const magnitudeVtkArray = vtkDataArray.newInstance({
numberOfComponents: 1, // Scalar data, only one component
values: magnitudeData, // Data values
name: 'velocityMagnitude', // Array name
});
imageData.getPointData().addArray(magnitudeVtkArray);

imageData.getPointData().setActiveScalars('velocityMagnitude');
imageData.setSpacing(2.5, 2.5, 1.0);

const newRange = magnitudeVtkArray.getRange();
console.log('Velocity magnitude range:', newRange);
const [minV, maxV] = newRange;

const marchingCube = vtkImageMarchingCubes.newInstance({
contourValue: minV + 0.5 * (maxV - minV), // Set isosurface value to middle of data range
computeNormals: true, // Compute normals for lighting effects
mergePoints: true // Merge duplicate points to reduce data size
});

marchingCube.setInputData(imageData);

const mapper = vtkMapper.newInstance();
mapper.setInputConnection(marchingCube.getOutputPort());

const actor = vtkActor.newInstance();
actor.setMapper(mapper);
renderer.addActor(actor);
const camera = renderer.getActiveCamera();
renderer.resetCameraClippingRange();
renderer.resetCamera();
renderWindow.render();
});
});
</script>
</body>

</html>