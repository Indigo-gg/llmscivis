<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deepwater Dataset Isosurface Rendering</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #renderer {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="renderer"></div>
  <script src="https://unpkg.com/vtk.js"></script>
  <script>
    const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
    const vtkActor = vtk.Rendering.Core.vtkActor;
    const vtkMapper = vtk.Rendering.Core.vtkMapper;
    const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
    const vtkImageMarchingCubes = vtk.Filters.General.vtkImageMarchingCubes;

    const fullScreenRenderWindow = vtkFullScreenRenderWindow.newInstance({
      background: [0.1, 0.1, 0.1],
    });
    const renderWindow = fullScreenRenderWindow.getRenderWindow();
    const renderer = fullScreenRenderWindow.getRenderer();

    // Load dataset
    const reader = vtkXMLImageDataReader.newInstance();
    reader.setUrl('http://127.0.0.1:5000/dataset/deepwater.vti').then(() => {
      reader.loadData().then(() => {
        const imageData = reader.getOutputData(0);

        // Compute velocity magnitude from v02, v03
        const v02Array = imageData.getPointData().getArrayByName('v02');
        const v03Array = imageData.getPointData().getArrayByName('v03');

        if (!v02Array || !v03Array) {
          console.error('v02 or v03 arrays not found in dataset');
          return;
        }

        const numPoints = imageData.getNumberOfPoints();
        const magnitudeData = new Float64Array(numPoints);
        const v02 = v02Array.getData();
        const v03 = v03Array.getData();

        for (let i = 0; i < numPoints; i++) {
          magnitudeData[i] = Math.sqrt(v02[i] * v02[i] + v03[i] * v03[i]);
        }

        const vtkDataArray = vtk.Common.Core.vtkDataArray;
        const magnitudeVtkArray = vtkDataArray.newInstance({
          numberOfComponents: 1,
          values: magnitudeData,
          name: 'velocityMagnitude',
        });
        imageData.getPointData().addArray(magnitudeVtkArray);
        imageData.getPointData().setActiveScalars('velocityMagnitude');

        // Get scalar range
        const activeScalars = imageData.getPointData().getScalars();
        const [minV, maxV] = activeScalars.getRange();
        console.log(minV, maxV);
        const isoValue = minV + 0.5 * (maxV - minV);

        // Create isosurface
        const marchingCube = vtkImageMarchingCubes.newInstance({
          contourValue: isoValue,
          computeNormals: true,
          mergePoints: true,
        });
        marchingCube.setInputData(imageData);

        const mapper = vtkMapper.newInstance();
        mapper.setInputConnection(marchingCube.getOutputPort());
        console.log(marchingCube.getOutputPort());

        const actor = vtkActor.newInstance();
        actor.setMapper(mapper);

        // Opaque, smooth shading
        actor.getProperty().setOpacity(1.0);
        actor.getProperty().setInterpolationToPhong();

        renderer.addActor(actor);

        // Camera setup
        renderer.resetCamera();
        renderWindow.render();

        // Orientation marker
        const axes = vtk.Rendering.Core.vtkAxesActor.newInstance();
        const widget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget.newInstance({
          actor: axes,
          interactor: renderWindow.getInteractor(),
        });
        widget.setEnabled(true);
        widget.setViewportCorner(
          vtk.Interaction.Widgets.vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT
        );
        widget.setViewportSize(0.15);
        widget.setMinPixelSize(100);
        widget.setMaxPixelSize(300);

        renderWindow.getInteractor().start();
      });
    });
  </script>
</body>
</html>
