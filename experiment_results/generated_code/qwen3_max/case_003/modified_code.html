<!DOCTYPE html>
<html>
<head>
  <title>VTK.js Isabel Dataset Streamline Visualization</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }
    #vtkContainer {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="vtkContainer"></div>
  <script type="module">
    import vtk from 'https://unpkg.com/vtk.js@34.10.0/vtk.js';

    // Get container and create renderer, render window, and interactor
    const container = document.getElementById('vtkContainer');
    const fullScreenRenderer = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance({
      background: [0, 0, 0],
      container: container
    });
    const renderer = fullScreenRenderer.getRenderer();
    const renderWindow = fullScreenRenderer.getRenderWindow();

    // Create reader for VTI dataset
    const reader = vtk.IO.XML.vtkXMLImageDataReader.newInstance();
    
    // Load the Isabel dataset from specified URL
    reader.setUrl('http://127.0.0.1:5000/dataset/isabel.vti').then(() => {
      reader.loadData().then(() => {
        const data = reader.getOutputData(0);
        
        // Get dataset bounds to compute center and create seed points
        const bounds = data.getBounds();
        const center = [
          (bounds[0] + bounds[1]) / 2,
          (bounds[2] + bounds[3]) / 2,
          (bounds[4] + bounds[5]) / 2
        ];
        
        // Create seed points at the center with sufficient density
        // Using a grid of seed points around the center to cover the domain
        const seedSource = vtk.Filters.Sources.vtkPointSource.newInstance();
        seedSource.setCenter(center);
        seedSource.setNumberOfPoints(100); // Sufficient density
        seedSource.setRadius(Math.min(
          (bounds[1] - bounds[0]) / 4,
          (bounds[3] - bounds[2]) / 4,
          (bounds[5] - bounds[4]) / 4
        ));
        
        // Create stream tracer using Velocity vector field
        const streamTracer = vtk.Filters.Flow.vtkStreamTracer.newInstance();
        streamTracer.setInputData(data);
        streamTracer.setVectors('Velocity'); // Use Velocity array as vector field
        streamTracer.setSeedData(seedSource.getOutputData());
        streamTracer.setMaximumPropagation(100);
        streamTracer.setInitialIntegrationStep(0.5);
        streamTracer.setIntegrationDirection(vtk.Filters.Flow.vtkStreamTracer.IntegrationDirection.BOTH);
        
        // Create mapper and actor for streamlines
        const streamlineMapper = vtk.Rendering.Core.vtkMapper.newInstance();
        streamlineMapper.setInputConnection(streamTracer.getOutputPort());
        
        const streamlineActor = vtk.Rendering.Core.vtkActor.newInstance();
        streamlineActor.setMapper(streamlineMapper);
        streamlineActor.getProperty().setColor(0, 1, 1); // Cyan color [0, 1, 1]
        streamlineActor.getProperty().setLineWidth(2); // Specified line width
        
        // Create outline of the dataset
        const outlineFilter = vtk.Filters.General.vtkOutlineFilter.newInstance();
        outlineFilter.setInputData(data);
        
        const outlineMapper = vtk.Rendering.Core.vtkMapper.newInstance();
        outlineMapper.setInputConnection(outlineFilter.getOutputPort());
        
        const outlineActor = vtk.Rendering.Core.vtkActor.newInstance();
        outlineActor.setMapper(outlineMapper);
        outlineActor.getProperty().setColor(1, 0, 0); // Red color [1, 0, 0]
        outlineActor.getProperty().setLineWidth(3); // Specified line width
        
        // Add actors to renderer
        renderer.addActor(streamlineActor);
        renderer.addActor(outlineActor);
        
        // Reset camera and render
        renderer.resetCamera();
        renderWindow.render();
      });
    }).catch(error => {
      console.error('Error loading dataset:', error);
    });

    // Set up interaction
    const interactor = renderWindow.getInteractor();
    interactor.initialize();
    interactor.bindEvents(container);
  </script>
</body>
</html>