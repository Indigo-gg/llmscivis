<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VTK.js - Isabel Streamline Visualization</title>
  <script src="https://unpkg.com/vtk.js@34.10.0/vtk.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
</head>
<body>
</body>
 <script>
    // 从全局vtk对象获取所需模块
    const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
    const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
    const vtkHttpDataSetReader = vtk.IO.Core.vtkHttpDataSetReader;
    const vtkStreamTracer = vtk.Filters.General.vtkStreamTracer;
    const vtkLineSource = vtk.Filters.Sources.vtkLineSource;
    const vtkTubeFilter = vtk.Filters.General.vtkTubeFilter;
    const vtkMapper = vtk.Rendering.Core.vtkMapper;
    const vtkActor = vtk.Rendering.Core.vtkActor;
    const vtkPointSource = vtk.Filters.Sources.vtkPointSource;
    const vtkImageStreamline = vtk.Filters.General.vtkImageStreamline;
    const vtkOutlineFilter = vtk.Filters.General.vtkOutlineFilter;
    // ----------------------------------------------------------------------------
    // Setup rendering environment
    // ----------------------------------------------------------------------------

    const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance();
    const renderer = fullScreenRenderer.getRenderer();
    const renderWindow = fullScreenRenderer.getRenderWindow();

    // ----------------------------------------------------------------------------
    // Load VTI Isabel Dataset
    // ----------------------------------------------------------------------------


      const reader=vtkXMLImageDataReader.newInstance();
    // Load the dataset from the specified URL
    // ✅ User requirement: Load from http://127.0.0.1:5000/dataset/isabel.vti
    reader.setUrl('http://127.0.0.1:5000/dataset/isabel.vti').then(() => {
      reader.loadData().then(() => {
        const imageData = reader.getOutputData();

        // Get dataset bounds
        const bounds = imageData.getBounds();
        const center = [
          (bounds[0] + bounds[1]) / 2,
          (bounds[2] + bounds[3]) / 2,
          (bounds[4] + bounds[5]) / 2,
        ];

        // ----------------------------------------------------------------------------
        // Generate seed points for streamlines
        // ----------------------------------------------------------------------------

        // ✅ User requirement: Seed at center with sufficient density
        const pointSource = vtkPointSource.newInstance({
        center: center,
        radius: Math.max(
            bounds[1] - bounds[0],
            bounds[3] - bounds[2],
            bounds[5] - bounds[4]
          ) * 0.4,
        numberOfPoints: 500 // We'll use more points for better coverage
      });

        // ----------------------------------------------------------------------------
        // Setup Stream Tracer
        // ----------------------------------------------------------------------------

        // ✅ User requirement: Use "Velocity" array
        const streamline = vtkImageStreamline.newInstance();
            streamline.setInputData(imageData);
            streamline.setInputConnection(pointSource.getOutputPort(), 1); // 种子点数据
            streamline.set({maximumNumberOfSteps: 1000,integrationStep: 0.5});
        // ----------------------------------------------------------------------------
        // Tube Filter to visualize streamlines as tubes
        // ----------------------------------------------------------------------------

        // ✅ User requirement: Render streamlines in cyan with line width
        const tubeFilter = vtkTubeFilter.newInstance();
        tubeFilter.setInputConnection(streamline.getOutputPort());
        tubeFilter.setRadius(0.3);
        tubeFilter.setNumberOfSides(12);

        const streamlineMapper = vtkMapper.newInstance();
        streamlineMapper.setInputConnection(tubeFilter.getOutputPort());

        const streamlineActor = vtkActor.newInstance();
        streamlineActor.setMapper(streamlineMapper);
        streamlineActor.getProperty().setColor(0, 1, 1); // Cyan
        streamlineActor.getProperty().setLineWidth(2);    // Line width

        renderer.addActor(streamlineActor);

        // ----------------------------------------------------------------------------
        // Add dataset outline in red
        // ----------------------------------------------------------------------------

        // ✅ User requirement: Outline in red with specified line width
        const outline = vtkOutlineFilter.newInstance();
        outline.setInputData(imageData);

        const outlineMapper = vtkMapper.newInstance();
        outlineMapper.setInputConnection(outline.getOutputPort());

        const outlineActor = vtkActor.newInstance();
        outlineActor.setMapper(outlineMapper);
        outlineActor.getProperty().setColor(1, 0, 0); // Red
        outlineActor.getProperty().setLineWidth(2);   // Line width

        renderer.addActor(outlineActor);

        // ----------------------------------------------------------------------------
        // Final render
        // ----------------------------------------------------------------------------

        renderer.resetCamera();
        renderWindow.render();
      });
    });
  </script>
</html>
