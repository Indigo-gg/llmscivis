<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTK.js Isabel Dataset Streamline Visualization</title>
    <script src="https://unpkg.com/vtk.js@34.10.0/vtk.js"></script>
</head>
<body>
    <div id="container"></div>

    <script>
        // Get VTK.js modules
        const vtkHttpDataAccessHelper = vtk.IO.Core.DataAccessHelper.HttpDataAccessHelper;
        const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
        const vtkImageStreamline = vtk.Filters.General.vtkImageStreamline;
        const vtkOutlineFilter = vtk.Filters.General.vtkOutlineFilter;
        const vtkPlaneSource = vtk.Filters.Sources.vtkPlaneSource;
        const vtkActor = vtk.Rendering.Core.vtkActor;
        const vtkMapper = vtk.Rendering.Core.vtkMapper;
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;

        // Create full screen render window
        const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
            background: [0, 0, 0],
            container: document.querySelector('#container')
        });
        const renderer = fullScreenRenderer.getRenderer();
        const renderWindow = fullScreenRenderer.getRenderWindow();

        // Create reader for the dataset
        const reader = vtkXMLImageDataReader.newInstance();
        reader.setUrl('http://127.0.0.1:5000/dataset/isabel.vti').then(() => {
            return reader.loadData();
        }).then(() => {
            // Get dataset bounds to position seed points at center
            const bounds = reader.getOutputData().getBounds();
            const xRange = bounds[1] - bounds[0];
            const yRange = bounds[3] - bounds[2];
            const zRange = bounds[5] - bounds[4];
            const center = [
                (bounds[0] + bounds[1]) / 2,
                (bounds[2] + bounds[3]) / 2,
                (bounds[4] + bounds[5]) / 2
            ];

            // Create plane source for seed points
            const planeSource = vtkPlaneSource.newInstance();
            planeSource.setOrigin(
                center[0] - xRange/4, 
                center[1] - yRange/4, 
                center[2] - zRange/4
            );
            planeSource.setPoint1(
                center[0] + xRange/4, 
                center[1] - yRange/4, 
                center[2] - zRange/4
            );
            planeSource.setPoint2(
                center[0] - xRange/4, 
                center[1] + yRange/4, 
                center[2] - zRange/4
            );
            planeSource.setXResolution(15);  // Adjust seed density
            planeSource.setYResolution(15);  // Adjust seed density

            // Create streamline filter
            const streamline = vtkImageStreamline.newInstance();
            streamline.setInputConnection(reader.getOutputPort());
            streamline.setInputConnection(planeSource.getOutputPort(), 1);
            streamline.setIntegrationStep(0.1);
            streamline.setInitialIntegrationStep(0.1);
            streamline.setMaximumNumberOfSteps(2000);
            streamline.setMaximumPropagation(100);
            streamline.setVorticity(true);
            streamline.setIntegrationDirection(0); // both directions
            streamline.setVectorFieldName('Velocity');  // Use Velocity array for streamlines

            // Create outline filter
            const outline = vtkOutlineFilter.newInstance();
            outline.setInputConnection(reader.getOutputPort());

            // Create mapper and actor for streamlines (cyan)
            const streamlineMapper = vtkMapper.newInstance();
            streamlineMapper.setInputConnection(streamline.getOutputPort());
            const streamlineActor = vtkActor.newInstance();
            streamlineActor.setMapper(streamlineMapper);
            streamlineActor.getProperty().setColor(0, 1, 1); // Cyan color
            streamlineActor.getProperty().setLineWidth(3);   // Line width

            // Create mapper and actor for outline (red)
            const outlineMapper = vtkMapper.newInstance();
            outlineMapper.setInputConnection(outline.getOutputPort());
            const outlineActor = vtkActor.newInstance();
            outlineActor.setMapper(outlineMapper);
            outlineActor.getProperty().setColor(1, 0, 0);    // Red color
            outlineActor.getProperty().setLineWidth(2);      // Line width

            // Add actors to renderer
            renderer.addActor(streamlineActor);
            renderer.addActor(outlineActor);

            // Reset camera and render
            renderer.resetCamera();
            renderWindow.render();
        });

        // Make variables available in console for debugging
        window.renderer = renderer;
        window.renderWindow = renderWindow;
    </script>
</body>
</html>