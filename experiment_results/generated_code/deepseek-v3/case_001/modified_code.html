<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTK.js Rotor Visualization</title>
    <style>
        body { margin: 0; }
        #container { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="container"></div>
    <script src="https://unpkg.com/vtk.js@34.10.0/vtk.js"></script>
    <script>
        // Import required VTK.js modules
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
        const vtkImageMapper = vtk.Rendering.Core.vtkImageMapper;
        const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
        const vtkOrientationMarkerWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget;
        
        // Create render window and renderer
        const fullScreenRenderWindow = vtkFullScreenRenderWindow.newInstance({
            rootContainer: document.querySelector('#container'),
            background: [0.1, 0.1, 0.1]
        });
        const renderer = fullScreenRenderWindow.getRenderer();
        const renderWindow = fullScreenRenderWindow.getRenderWindow();
        
        // Create reader for VTI file
        const reader = vtkXMLImageDataReader.newInstance();
        reader.setUrl('http://127.0.0.1:5000/dataset/rotor.vti').then(() => {
            // Get image data from reader
            const imageData = reader.getOutputData();
            
            // Set active scalar to "Pressure"
            imageData.getPointData().setActiveScalars('Pressure');
            const scalarRange = imageData.getPointData().getScalars().getRange();
            
            // Create color transfer function (blue-white-red)
            const colorTransferFunction = vtkColorTransferFunction.newInstance();
            colorTransferFunction.addRGBPoint(scalarRange[0], 0, 0, 1); // Blue at min
            colorTransferFunction.addRGBPoint(
                (scalarRange[0] + scalarRange[1]) / 2, 
                1, 1, 1); // White at midpoint
            colorTransferFunction.addRGBPoint(scalarRange[1], 1, 0, 0); // Red at max
            
            // Calculate Y slice index (95% depth)
            const extent = imageData.getExtent();
            const ySliceIndex = Math.round(extent[2] + (extent[3] - extent[2]) * 0.95);
            
            // Create mapper and actor for Y slice
            const mapper = vtkImageMapper.newInstance();
            mapper.setInputData(imageData);
            mapper.setJSlice(ySliceIndex);
            mapper.setSliceAtFocalPoint(true);
            
            const actor = vtkImageSlice.newInstance();
            actor.setMapper(mapper);
            
            // Apply color map and set opacity to fully opaque
            actor.getProperty().setRGBTransferFunction(colorTransferFunction);
            actor.getProperty().setUseLookupTableScalarRange(true);
            actor.getProperty().setOpacity(1.0);
            
            // Add actor to renderer
            renderer.addActor(actor);
            
            // Add orientation marker
            const axes = vtk.Rendering.Core.vtkAnnotatedCubeActor.newInstance();
            axes.setDefaultStyle({
                text: '+X',
                fontStyle: 'bold',
                fontFamily: 'Arial',
                fontColor: [0, 0, 0],
                fontSizeScale: res => res / 2,
                faceColor: [1, 1, 1],
                faceRotation: 0,
                edgeThickness: 0.1,
                edgeColor: [0, 0, 0],
            });
            
            const widget = vtkOrientationMarkerWidget.newInstance({
                actor: axes,
                interactor: renderWindow.getInteractor()
            });
            widget.setEnabled(true);
            widget.setViewportCorner(vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT);
            
            // Reset camera and render
            renderer.resetCamera();
            renderWindow.render();
        });
    </script>
</body>
</html>