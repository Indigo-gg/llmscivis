<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotor Dataset Visualization</title>
    <style>
        #renderer {
            width: 100%;
            height: 600px;
            background-color: #333;
        }
    </style>
</head>
<body>
    <div id="renderer"></div>
    <script src="https://unpkg.com/vtk.js@34.10.0/vtk.js"></script>
    <script>
        // Load required VTK modules
        const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
        const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
        const vtkImageMapper = vtk.Rendering.Core.vtkImageMapper;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
        const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
        const vtkAxesActor = vtk.Rendering.Core.vtkAxesActor;
        const vtkOrientationMarkerWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget;
        const vtkRenderer = vtk.Rendering.Core.vtkRenderer;
        const vtkRenderWindow = vtk.Rendering.Core.vtkRenderWindow;
        const vtkRenderWindowInteractor = vtk.Rendering.Core.vtkRenderWindowInteractor;

        // Create renderer, render window, and interactor
        const renderer = vtkRenderer.newInstance({ background: [0.2, 0.2, 0.2] });
        const renderWindow = vtkRenderWindow.newInstance();
        renderWindow.addRenderer(renderer);
        const interactor = vtkRenderWindowInteractor.newInstance();
        interactor.setRenderWindow(renderWindow);

        // Create container for the renderer
        const container = document.getElementById('renderer');
        renderWindow.addView(container);

        // Load rotor dataset from local server
        const reader = vtkXMLImageDataReader.newInstance();
        reader.setUrl('http://127.0.0.1:5000/dataset/rotor.vti', { loadData: true }).then(() => {
            const imageData = reader.getOutputData(0);
            
            // Set active scalar array to 'Pressure'
            imageData.getPointData().setActiveScalars('Pressure');
            const pressureArray = imageData.getPointData().getScalars('Pressure');
            const scalarRange = pressureArray.getRange();

            // Compute slice index at 95% depth along Y-axis (J direction)
            const dimensions = imageData.getDimensions();
            const sliceIndex = Math.floor(dimensions[1] * 0.95); // Y-axis corresponds to J dimension

            // Create image mapper and set the J slice
            const mapper = vtkImageMapper.newInstance();
            mapper.setInputData(imageData);
            mapper.setJSlice(sliceIndex);

            // Create color transfer function (blue → white → red)
            const ctfun = vtkColorTransferFunction.newInstance();
            ctfun.addRGBPoint(scalarRange[0], 0, 0, 1);      // Blue at min
            ctfun.addRGBPoint((scalarRange[0] + scalarRange[1]) / 2, 1, 1, 1); // White at mid
            ctfun.addRGBPoint(scalarRange[1], 1, 0, 0);      // Red at max

            // Create opacity function (fully opaque)
            const ofun = vtkPiecewiseFunction.newInstance();
            ofun.addPoint(scalarRange[0], 1.0);
            ofun.addPoint(scalarRange[1], 1.0);

            // Create image slice actor
            const actor = vtkImageSlice.newInstance();
            actor.setMapper(mapper);
            actor.getProperty().setRGBTransferFunction(0, ctfun);
            actor.getProperty().setScalarOpacity(0, ofun);

            // Add actor to renderer
            renderer.addActor(actor);

            // Add orientation marker (XYZ axes)
            const axes = vtkAxesActor.newInstance();
            const orientationWidget = vtkOrientationMarkerWidget.newInstance({
                actor: axes,
                interactor: interactor,
                viewportCorner: vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT,
                viewportSize: 0.15,
            });
            orientationWidget.setEnabled(true);
            orientationWidget.setViewportCorner(vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT);

            // Reset camera and render
            renderer.resetCamera();
            renderWindow.render();
        });

        // Initialize interactor
        interactor.initialize();
        interactor.bindEvents(container);
    </script>
</body>
</html>