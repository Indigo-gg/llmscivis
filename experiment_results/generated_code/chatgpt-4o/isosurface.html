<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Deepwater Isosurface Visualization</title>
  <script src="https://unpkg.com/vtk.js@34.10.0/vtk.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #container {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>

<body>
  <div id="container"></div>
  <script>
    // ----------------------------------------------------------------------------
    // Import required VTK.js modules
    // ----------------------------------------------------------------------------
    const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
    const vtkHttpDataSetReader = vtk.IO.Core.vtkHttpDataSetReader;
    const vtkMapper = vtk.Rendering.Core.vtkMapper;
    const vtkActor = vtk.Rendering.Core.vtkActor;
    const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
    const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
    const vtkContourFilter = vtk.Filters.General.vtkContourFilter;
    const vtkCalculator = vtk.Filters.General.vtkCalculator;
    const vtkOrientationMarkerWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget;
    const vtkAxesActor = vtk.Rendering.Core.vtkAxesActor;

    // ----------------------------------------------------------------------------
    // Create renderer and render window
    // ----------------------------------------------------------------------------
    const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
      background: [0.1, 0.1, 0.1],
      rootContainer: document.getElementById('container')
    });
    const renderer = fullScreenRenderer.getRenderer();
    const renderWindow = fullScreenRenderer.getRenderWindow();

    // ----------------------------------------------------------------------------
    // Load the dataset
    // ----------------------------------------------------------------------------
    const reader = vtkHttpDataSetReader.newInstance({ fetchGzip: true });
    reader.setUrl('http://127.0.0.1:5000/dataset/deepwater.vti').then(() => {
      reader.loadData().then(() => {
        const imageData = reader.getOutputData();
        const pointData = imageData.getPointData();

        // ----------------------------------------------------------------------------
        // Compute velocity magnitude if v02 and v03 exist, otherwise use 'prs'
        // ----------------------------------------------------------------------------
        const arrayNames = pointData.getArrays().map(arr => arr.getName());
        let scalarName = 'prs';

        if (arrayNames.includes('v02') && arrayNames.includes('v03')) {
          const calculator = vtkCalculator.newInstance();
          calculator.setInputData(imageData);
          calculator.setFormula({
            getArrays: inputDataSets => ({
              v02: inputDataSets[0].getPointData().getArrayByName('v02'),
              v03: inputDataSets[0].getPointData().getArrayByName('v03'),
            }),
            evaluate: ({ v02, v03 }) => {
              return [Math.sqrt(v02[0] ** 2 + v03[0] ** 2)];
            },
            output: {
              name: 'velocityMag',
              type: 'Float32Array',
              numberOfComponents: 1,
            }
          });
          calculator.update();
          scalarName = 'velocityMag';
        }

        // ----------------------------------------------------------------------------
        // Create contour filter (isosurface) at mid-value of scalar range
        // ----------------------------------------------------------------------------
        const contour = vtkContourFilter.newInstance();
        contour.setInputConnection(reader.getOutputPort());
        contour.setComputeNormals(true);
        contour.setComputeGradients(true);
        contour.setComputeScalars(true);
        contour.setInputArrayToProcess(0, 'Scalars', 'PointData', 'Scalars', scalarName);

        // Wait for scalar range to be available
        renderWindow.render(); // Ensure pipeline updates
        setTimeout(() => {
          const scalars = pointData.getArrayByName(scalarName);
          const range = scalars.getRange();
          const midValue = (range[0] + range[1]) / 2;
          contour.setValue(0, midValue); // generate isosurface at mid-value

          // ----------------------------------------------------------------------------
          // Create mapper and actor
          // ----------------------------------------------------------------------------
          const mapper = vtkMapper.newInstance();
          mapper.setInputConnection(contour.getOutputPort());

          // Set color mapping: blue → white → red
          const lookupTable = vtkColorTransferFunction.newInstance();
          lookupTable.addRGBPoint(range[0], 0, 0, 1);     // Blue
          lookupTable.addRGBPoint(midValue, 1, 1, 1);     // White
          lookupTable.addRGBPoint(range[1], 1, 0, 0);     // Red

          mapper.setLookupTable(lookupTable);
          mapper.setUseLookupTableScalarRange(true);

          const actor = vtkActor.newInstance();
          actor.setMapper(mapper);

          // Fully opaque and smooth shading
          actor.getProperty().setOpacity(1.0);
          actor.getProperty().setInterpolationToPhong(); // smooth shading

          // ----------------------------------------------------------------------------
          // Add actor and render
          // ----------------------------------------------------------------------------
          renderer.addActor(actor);
          renderer.resetCamera();
          renderWindow.render();
        }, 500); // delay to allow scalar data to load

        // ----------------------------------------------------------------------------
        // Add orientation marker in bottom-right corner
        // ----------------------------------------------------------------------------
        const axes = vtkAxesActor.newInstance();
        const orientationWidget = vtkOrientationMarkerWidget.newInstance({
          actor: axes,
          interactor: renderWindow.getInteractor(),
        });
        orientationWidget.setEnabled(true);
        orientationWidget.setViewportCorner(
          vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT
        );
        orientationWidget.setViewportSize(0.15);
        orientationWidget.setMinPixelSize(100);
        orientationWidget.setMaxPixelSize(300);
      });
    });

  </script>
</body>

</html>