# RAG 两阶段检索结果统计分析 使用指南

## 📋 概述

本分析脚本针对 RAG（检索增强生成）系统的两个阶段检索结果进行深入统计分析，主要功能包括：

1. **两阶段对比分析** - 对比初筛（第一阶段）和重排序（第二阶段）的检索结果
2. **丢失项目分析** - 统计初筛中发现但重排序中丢失的检索结果
3. **模块统计分析** - 分析 VTK.js 模块的使用情况和丢失分布
4. **查询效果分析** - 评估各查询的检索效果

## 🚀 运行方式

```bash
python experiment_results/analys/retriever_res_analys.py
```

## 📊 输出文件

脚本会生成以下分析报告：

### 1. **retrieval_comprehensive_analysis.xlsx** ✨
   综合分析报告，包含多个 Sheet：
   
   - **统计摘要**: 核心指标汇总
     - 两阶段总结果数对比
     - 丢失统计
     - 相似度统计
     - 模块统计
   
   - **阈值分析**: 不同相似度阈值下的结果数变化
     - 按 0.5, 0.6, 0.7, 0.8, 0.9 相似度阈值统计
     - 显示每个阈值下两阶段的结果数和丢失数
   
   - **模块统计**: VTK.js 模块使用频率统计
     - 模块名称
     - 使用次数
     - 使用比例（%）
   
   - **查询效果**: 各查询的检索效果评估
     - 查询 ID
     - 返回结果数
     - 平均相似度
     - 相似度范围
     - 高质量结果数（≥0.5 的相似度）

### 2. **lost_items_detailed_analysis.xlsx**
   丢失项目详细分析（如果存在丢失）
   
   - **丢失结果**: 初筛发现但重排序丢失的具体项目
   - **统计摘要**: 丢失统计

## 📈 关键指标解释

### 两阶段检索对比
```
📊 基本统计:
  • 第一阶段（初筛）总结果数: FAISS 语义搜索返回的所有结果
  • 第二阶段（重排序）总结果数: 经过 VTK.js 模块匹配重排后的结果
  • 丢失的结果数: 初筛有但重排序没有的结果
  • 丢失率: (丢失数 / 初筛总数) × 100%
```

### 相似度统计
```
• 平均相似度: 所有结果的 FAISS 相似度平均值
• 中位数相似度: 相似度的中位数（鲁棒性更强）
• 相似度范围: [最小值, 最大值]
• 标准差: 相似度的离散程度
```

### VTK.js 模块统计
```
• 不同模块总数: 检索结果中涉及的不同 VTK.js 模块数
• 平均每个结果包含的模块数: 显示代码示例的复杂度
• 使用最频繁的模块: Top 15 模块的使用分布
```

### 查询效果评估
```
• 高质量结果数(≥0.5): 相似度≥0.5 的结果数（推荐阈值）
• 效果最好的查询: 平均相似度最高的查询
• 效果最差的查询: 平均相似度最低的查询
```

## 🔍 分析类说明

### RetrieverAnalyzer 类

主要方法：

1. **analyze_loss_between_stages()**
   - 分析初筛和重排序之间的结果丢失
   - 返回丢失项目、模块分析等详细信息

2. **analyze_stage_comparison()**
   - 对比两个阶段的统计特性
   - 分析不同相似度阈值下的结果分布

3. **analyze_vtkjs_modules()**
   - 统计所有 VTK.js 模块的使用情况
   - 计算模块频率和分布

4. **analyze_query_effectiveness()**
   - 评估每个查询的检索效果
   - 找出最好和最差的查询

5. **generate_comprehensive_report()**
   - 生成综合分析报告
   - 导出多个 Sheet 的 Excel 文件

## 💡 使用建议

1. **定期运行分析**
   - 在新增检索结果后运行分析
   - 跟踪检索效果的变化趋势

2. **重点关注**
   - 丢失率：如果过高，说明重排算法需要优化
   - 低相似度查询：可能需要调整查询分解策略
   - 高频模块：这些模块的质量最重要

3. **优化方向**
   - 改进重排算法以减少丢失率
   - 针对效果差的查询优化分解策略
   - 针对高频模块的检索效果进行优化

## 📝 数据来源

脚本使用以下数据文件：

- `retrieval_results_12_2.json` - RAG 检索结果的 JSON 备份
- `retrieval_results_detailed_12_2_15.xlsx` - 两阶段检索结果的详细 Excel 表

## ⚙️ 依赖库

```
pandas >= 1.3.0
openpyxl >= 3.0.0
numpy >= 1.20.0
matplotlib >= 3.3.0
```

## 📧 反馈

如有问题或建议，请联系开发团队。
