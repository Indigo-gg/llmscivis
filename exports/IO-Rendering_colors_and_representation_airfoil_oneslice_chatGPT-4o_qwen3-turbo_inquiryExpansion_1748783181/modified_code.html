<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Airfoil Visualization using Scalar 'p'</title>
    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: #000;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <!-- VTK.js (最新版本) -->
    <script src="https://unpkg.com/vtk.js"></script>

    <script>
        // 导入模块
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkXMLPolyDataReader = vtk.IO.XML.vtkXMLPolyDataReader;
        const vtkMapper = vtk.Rendering.Core.vtkMapper;
        const vtkActor = vtk.Rendering.Core.vtkActor;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;

        // 初始化 vtk 渲染窗口
        const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
            rootContainer: document.getElementById("container"),
            background: [0, 0, 0],
        });
        const renderer = fullScreenRenderer.getRenderer();
        const renderWindow = fullScreenRenderer.getRenderWindow();

        // 创建读取器
        const reader = vtkXMLPolyDataReader.newInstance();

        // 加载 .vtp 数据
        fetch("http://127.0.0.1:5000/dataset/airfoil_oneslice.vtp")
            .then(response => response.arrayBuffer())
            .then(data => {
                reader.parseAsArrayBuffer(data);
                const polyData = reader.getOutputData();

                // 设置激活标量字段为 'p'
                const pointData = polyData.getPointData();
                pointData.setActiveScalars("p");

                const pArray = pointData.getScalars();
                const [min, max] = pArray.getRange();
                const mid = (min + max) / 2;

                // 构造颜色映射：Blue → White → Red
                const colorMap = vtkColorTransferFunction.newInstance();
                colorMap.addRGBPoint(min, 0.0, 0.0, 1.0);  // 蓝色
                colorMap.addRGBPoint(mid, 1.0, 1.0, 1.0);  // 白色
                colorMap.addRGBPoint(max, 1.0, 0.0, 0.0);  // 红色

                // 渲染设置：mapper + actor
                const mapper = vtkMapper.newInstance();
                mapper.setInputConnection(reader.getOutputPort());
                mapper.setLookupTable(colorMap);
                mapper.setScalarRange(min, max);
                mapper.setColorByArrayName("p");

                const actor = vtkActor.newInstance();
                actor.setMapper(mapper);

                // 优化表面视觉效果（模拟体感）
                actor.getProperty().setInterpolationToPhong();
                actor.getProperty().setSpecular(0.4);
                actor.getProperty().setSpecularPower(20);
                actor.getProperty().setOpacity(1.0); // 全不透明，但可调整为 0.6 类似 volume

                // 添加 actor 并设置相机
                renderer.addActor(actor);
                renderer.resetCamera();
                renderer.getRenderWindow().render();
            })
            .catch(error => {
                console.error("加载或解析 VTP 文件失败：", error);
            });
    </script>
</body>

</html>