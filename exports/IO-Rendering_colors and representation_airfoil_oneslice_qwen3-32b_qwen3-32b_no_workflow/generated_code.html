<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Volume Rendering with vtk.js</title>
  <!-- Load the vtk.js library from a CDN -->
  <script src="https://unpkg.com/vtk.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #vtkContainer {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <!-- Div container for the vtk render window -->
  <div id="vtkContainer"></div>

  <script>
    // Entry point of the application
    (async function () {
      // Import required modules from vtk.js
      const vtk = window.vtk;
      const vtkActor = vtk.Rendering.Core.vtkActor;
      const vtkMapper = vtk.Rendering.Core.vtkMapper;
      const vtkRenderWindow = vtk.Rendering.Core.vtkRenderWindow;
      const vtkRenderer = vtk.Rendering.Core.vtkRenderer;
      const vtkRenderWindowInteractor = vtk.Rendering.Core.vtkRenderWindowInteractor;
      const vtkHttpDataSetReader = vtk.IO.HTTP.vtkHttpDataSetReader;
      const vtkColorTransferFunction = vtk.Common.DataModel.vtkColorTransferFunction;

      // Create the render window and renderer
      const renderWindow = vtkRenderWindow.newInstance();
      const renderer = vtkRenderer.newInstance();
      renderWindow.addRenderer(renderer);

      // Create an interactor to handle user interaction
      const interactor = vtkRenderWindowInteractor.newInstance();
      interactor.setRenderWindow(renderWindow);

      // Create a reader to load the VTP file from the local server
      const reader = vtkHttpDataSetReader.newInstance({ url: 'http://127.0.0.1:5000/dataset/airfoil_oneslice.vtp' });

      // Wait for the data to be read
      await reader.loadData();

      // Create a mapper and set the input connection from the reader
      const mapper = vtkMapper.newInstance();
      mapper.setInputConnection(reader.getOutputPort());

      // Set scalar visibility to true to use scalar values for color mapping
      mapper.setScalarVisibility(true);
      // Specify the scalar array name "p" for color encoding
      mapper.setColorArrayName('p');
      // Use scalar mode to map by point data
      mapper.setScalarModeToUsePointData();

      // Create a color transfer function for scalar mapping
      const colorTransferFunction = vtkColorTransferFunction.newInstance();
      // Add color stops for the scalar range (you can customize these as needed)
      colorTransferFunction.addRGBPoint(0.0, 0.0, 0.0, 1.0); // Black at low scalar value
      colorTransferFunction.addRGBPoint(1.0, 1.0, 0.0, 0.0); // Red at high scalar value

      // Assign the color transfer function to the mapper
      mapper.setLookupTable(colorTransferFunction);

      // Create an actor and set the mapper
      const actor = vtkActor.newInstance();
      actor.setMapper(mapper);

      // Add the actor to the renderer
      renderer.addActor(actor);

      // Get the bounds of the dataset to position the camera correctly
      const bounds = reader.getOutputData().getBounds();
      console.log("Dataset Bounds:", bounds);

      // Position the camera to focus on the dataset
      const center = [
        (bounds[0] + bounds[1]) / 2,
        (bounds[2] + bounds[3]) / 2,
        (bounds[4] + bounds[5]) / 2
      ];

      // Set camera position to view the dataset from a default angle
      const camera = renderer.getActiveCamera();
      camera.setPosition(center[0], center[1], center[2] + 50); // Adjust z-position for better view
      camera.setFocalPoint(center[0], center[1], center[2]);
      camera.setClippingRange(0.1, 1000);

      // Render the scene
      renderWindow.render();

      // Start the interactor to enable mouse and keyboard controls
      interactor.initialize();
      interactor.start();
    })();
  </script>
</body>
</html>
