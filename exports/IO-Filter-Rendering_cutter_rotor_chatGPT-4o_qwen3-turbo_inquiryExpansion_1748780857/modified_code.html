<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>VTK.js Rotor Sliced Visualization</title>
    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <!-- Import vtk.js -->
    <script src="https://unpkg.com/vtk.js"></script>

    <script>
        ///// üîß ÂºïÂÖ•Ê†∏ÂøÉÊ®°Âùó /////
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
        const vtkImageMapper = vtk.Rendering.Core.vtkImageMapper;
        const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
        const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
        const vtkAxesActor = vtk.Rendering.Core.vtkAxesActor;
        const vtkOrientationMarkerWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget;

        ///// üñ•Ô∏è ÂàõÂª∫ÂÖ®Â±èÊ∏≤Êüì‰∏ä‰∏ãÊñá /////
        const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
            rootContainer: document.getElementById('container'),
            background: [0.1, 0.1, 0.1],
        });

        const renderer = fullScreenRenderer.getRenderer();
        const renderWindow = fullScreenRenderer.getRenderWindow();

        ///// üì¶ ÂàõÂª∫ VTI Êï∞ÊçÆËØªÂèñÂô® /////
        const reader = vtkXMLImageDataReader.newInstance();

        ///// üì• ÂºÇÊ≠•Âä†ËΩΩ .vti Êñá‰ª∂ /////
        fetch('http://127.0.0.1:5000/dataset/rotor_simplified.vti')
            .then(response => response.arrayBuffer())
            .then(buffer => {
                reader.parseAsArrayBuffer(buffer);

                const imageData = reader.getOutputData();

                ///// üéØ ËÆæÁΩÆ "Pressure" ‰∏∫Ê¥ªÂä®Ê†áÈáè /////
                imageData.getPointData().setActiveScalars('Pressure');

                ///// ‚úÇÔ∏è ËÆæÁΩÆÂàáÁâáÂèÇÊï∞ÔºöÊ≤ø Y ËΩ¥ÊñπÂêëÔºàslicingMode = 1Ôºâ /////
                const mapper = vtkImageMapper.newInstance();
                mapper.setInputData(imageData);
                mapper.setSlicingMode(1); // 0-x, 1-y, 2-z

                // ËÆ°ÁÆó Y ÊñπÂêë 80% ‰ΩçÁΩÆ
                const dims = imageData.getDimensions();
                // const bounds = imageData.getBounds();
                // const yMin = bounds[2];
                // const yMax = bounds[3];
                // const ySlicePos = yMin + (yMax - yMin) * 0.8;
                mapper.setSlice(dims[1] * 0.8);

                ///// üé≠ ÂàõÂª∫ Image Slice Actor /////
                const slice = vtkImageSlice.newInstance();
                slice.setMapper(mapper);

                ///// üé® ËÆæÁΩÆÈ¢úËâ≤Êò†Â∞ÑÔºàblue ‚Üí white ‚Üí redÔºâ /////
                const pressureArray = imageData.getPointData().getScalars();
                const [min, max] = pressureArray.getRange();
                const mid = (min + max) / 2;

                const colorMap = vtkColorTransferFunction.newInstance();
                colorMap.addRGBPoint(min, 0.0, 0.0, 1.0);  // Blue
                colorMap.addRGBPoint(mid, 1.0, 1.0, 1.0);  // White
                colorMap.addRGBPoint(max, 1.0, 0.0, 0.0);  // Red

                const opacityMap = vtkPiecewiseFunction.newInstance();
                opacityMap.addPoint(min, 1.0); // ÂÖ®‰∏çÈÄèÊòé
                opacityMap.addPoint(max, 1.0);

                slice.getProperty().setRGBTransferFunction(0, colorMap);
                slice.getProperty().setPiecewiseFunction(0, opacityMap);
                slice.getProperty().setInterpolationTypeToLinear();

                ///// ‚ûï Ê∑ªÂä†ÂàáÁâáÂà∞Âú∫ÊôØ /////
                renderer.addActor(slice);

                ///// üß≠ Ê∑ªÂä† XYZ Á©∫Èó¥ÊñπÂêëÊåáÁ§∫Âô® /////
                const axes = vtkAxesActor.newInstance();
                const orientationWidget = vtkOrientationMarkerWidget.newInstance({
                    actor: axes,
                    interactor: renderWindow.getInteractor(),
                });
                orientationWidget.setEnabled(true);
                orientationWidget.setViewportCorner(
                    vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT
                );
                orientationWidget.setViewportSize(0.15);
                orientationWidget.setMinPixelSize(100);
                orientationWidget.setMaxPixelSize(300);

                ///// üì∑ Ê∏≤ÊüìÂíåÁõ∏Êú∫ËÆæÁΩÆ /////
                renderer.resetCamera();
                renderWindow.render();
            })
            .catch(error => {
                console.error('‚ùå Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•Ôºö', error);
            });
    </script>
</body>

</html>