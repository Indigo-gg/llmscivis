<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VTK.js Rotor Data Visualization</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #vtk-container {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <!-- 容器用于放置VTK渲染窗口 -->
  <div id="vtk-container"></div>

  <!-- 引入 VTK.js 库 -->
  <script src="https://unpkg.com/vtk.js"></script>

  <script>
    // 用户需求分析：
    // 1. 加载VTI文件（来自指定URL）
    // 2. 使用Y轴切片（setSlicingMode, setSlice）
    // 3. 显示Pressure标量场，使用颜色映射和不透明度控制
    // 4. 添加XYZ方向的朝向标记

    // 导入所需的VTK模块
    const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
    const vtkHttpDataSetReader = vtk.IO.Core.vtkHttpDataSetReader;
    const vtkImageMapper = vtk.Rendering.Core.vtkImageMapper;
    const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
    const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
    const vtkPiecewiseFunction = vtk.Common.Core.vtkPiecewiseFunction;
    const vtkOrientationMarkerWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget;
    const vtkAnnotatedCubeActor = vtk.Rendering.Core.vtkAnnotatedCubeActor;

    // 初始化全屏渲染窗口
    const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
      background: [0, 0, 0],
      rootContainer: document.body,
      containerStyle: { height: '100%' },
      renderWindowSize: { width: window.innerWidth, height: window.innerHeight },
    });

    const renderer = fullScreenRenderer.getRenderer();
    const renderWindow = fullScreenRenderer.getRenderWindow();

    // 创建图像切片对象
    const imageSlice = vtkImageSlice.newInstance();
    const mapper = vtkImageMapper.newInstance();

    // 设置数据读取器（加载远程VTI文件）
    const reader = vtkHttpDataSetReader.newInstance({ fetchGzip: true });
    reader.setUrl('http://127.0.0.1:5000/dataset/rotor.vti').then(() => {
      reader.update();

      const imageData = reader.getOutputData(0);

      // 设置mapper的数据源为读取的图像数据
      mapper.setInputData(imageData);
      mapper.setSlicingMode(1); // Y轴切片
      mapper.setSlice(Math.floor(imageData.getDimensions()[1] * 0.8)); // 80% 深度

      // 设置图像切片的映射器
      imageSlice.setMapper(mapper);

      // 创建颜色映射函数：蓝 -> 白 -> 红
      const colorMap = vtkColorTransferFunction.newInstance();
      colorMap.addRGBPoint(-1000, 0.0, 0.0, 1.0); // 蓝色
      colorMap.addRGBPoint(0, 1.0, 1.0, 1.0);     // 白色
      colorMap.addRGBPoint(1000, 1.0, 0.0, 0.0);  // 红色

      // 设置不透明度为完全不透明
      const opacityFunction = vtkPiecewiseFunction.newInstance();
      opacityFunction.addPoint(0, 1.0);
      opacityFunction.addPoint(1000, 1.0);

      // 将颜色和不透明度应用到图像属性
      const prop = imageSlice.getProperty();
      prop.setColor(colorMap);
      prop.setOpacity(opacityFunction);

      // 将图像添加到渲染器中
      renderer.addActor(imageSlice);

      // 添加朝向标记（XYZ坐标轴）
      const cubeActor = vtkAnnotatedCubeActor.newInstance();
      cubeActor.setDefaultStyle({
        fontSize: 18,
        faceRotation: 0,
        xFaceText: 'X',
        yFaceText: 'Y',
        zFaceText: 'Z',
        xyFaceColor: [255, 0, 0],
        yzFaceColor: [0, 255, 0],
        zxFaceColor: [0, 0, 255],
      });

      const orientationWidget = vtkOrientationMarkerWidget.newInstance({
        actor: cubeActor,
        interaction: false,
      });

      orientationWidget.setInteractor(renderWindow.getInteractor());
      orientationWidget.setEnabled(true);
      orientationWidget.setViewportCorner(0, 0, 0.2, 0.2); // 左下角显示

      // 初始渲染
      renderer.resetCamera();
      renderWindow.render();
    });

    // 监听窗口大小变化以更新渲染器尺寸
    window.addEventListener('resize', () => {
      fullScreenRenderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>


---

### ✅ 功能说明与用户需求满足点：

1. **加载VTI格式的转子数据**  
   - 使用 `vtkHttpDataSetReader` 从 `http://127.0.0.1:5000/dataset/rotor.vti` 加载 VTIData 数据。

2. **Y轴方向切片设置在80%深度**  
   - 使用 `mapper.setSlicingMode(1)` 设置 Y 轴方向切片。
   - 使用 `mapper.setSlice(...)` 设置切片位置为 Y 轴维度的 80%。

3. **压力值的颜色映射（蓝→白→红）与全不透明**  
   - 使用 `vtkColorTransferFunction` 实现从蓝色到白色再到红色的渐变映射。
   - 使用 `vtkPiecewiseFunction` 设置恒定的不透明度（1.0）。

4. **添加XYZ方向的朝向标记**  
   - 使用 `vtkAnnotatedCubeActor` 和 `vtkOrientationMarkerWidget` 在视图角落添加一个带标签的坐标系。

5. **无GUI控件要求**  
   - 所有操作均通过代码设定，未引入任何交互式UI组件。

6. **使用HTML+VTK.js实现三维可视化**  
   - 基于 `vtkFullScreenRenderWindow` 构建完整渲染环境，适用于浏览器端展示。

---

### 📌 注意事项：

- 确保后端服务器运行在 `http://127.0.0.1:5000` 并正确提供 `rotor.vti` 文件。
- 若出现跨域问题，请配置CORS或使用代理服务器。
- 可根据实际压力范围调整 `colorMap.addRGBPoint()` 的输入参数。