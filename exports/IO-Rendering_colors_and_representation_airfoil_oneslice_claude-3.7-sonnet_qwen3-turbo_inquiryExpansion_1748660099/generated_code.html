<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VTK.js Volume Rendering</title>
</head>
<body>
    <div id="renderer"></div>
    <script src="https://unpkg.com/vtk.js"></script>
    <script>
        // Import required vtk.js modules
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkActor = vtk.Rendering.Core.vtkActor;
        const vtkMapper = vtk.Rendering.Core.vtkMapper;
        const vtkXMLPolyDataReader = vtk.IO.XML.vtkXMLPolyDataReader;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;

        // Create rendering window
        const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
            background: [0.2, 0.2, 0.2]
        });
        const renderer = fullScreenRenderer.getRenderer();
        const renderWindow = fullScreenRenderer.getRenderWindow();

        // Create reader for VTP file
        const reader = vtkXMLPolyDataReader.newInstance();

        // Create mapper and actor
        const mapper = vtkMapper.newInstance();
        const actor = vtkActor.newInstance();
        actor.setMapper(mapper);

        // Set up color mapping
        const lookupTable = vtkColorTransferFunction.newInstance();
        // Add color points for pressure field
        lookupTable.addRGBPoint(-1.0, 0.0, 0.0, 1.0);  // Blue for low pressure
        lookupTable.addRGBPoint(0.0, 0.0, 1.0, 0.0);   // Green for medium pressure
        lookupTable.addRGBPoint(1.0, 1.0, 0.0, 0.0);   // Red for high pressure

        // Load and process the data
        fetch('http://127.0.0.1:5000/dataset/airfoil_oneslice.vtp')
            .then(response => response.arrayBuffer())
            .then(data => {
                // Parse the VTP data
                reader.parseAsArrayBuffer(data);
                const polyData = reader.getOutputData();

                // Set the input data to the mapper
                mapper.setInputData(polyData);
                
                // Activate pressure scalar array for coloring
                mapper.setScalarVisibility(true);
                mapper.setScalarMode(vtk.Rendering.Core.vtkMapper.ScalarMode.USE_POINT_FIELD_DATA);
                mapper.setColorModeToMapScalars();
                mapper.setScalarRange(polyData.getPointData().getScalars('p').getRange());
                mapper.setLookupTable(lookupTable);

                // Add actor to renderer
                renderer.addActor(actor);

                // Reset camera to focus on the dataset
                renderer.resetCamera();
                renderWindow.render();
            })
            .catch(error => console.error('Error loading the VTP file:', error));
    </script>
</body>
</html>