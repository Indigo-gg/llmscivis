<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Airfoil Volume-like Visualization</title>
    <style>
        html,
        body,
        #container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <!-- 引入 VTK.js CDN -->
    <script src="https://unpkg.com/vtk.js"></script>

    <script>
        // 引入模块
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkXMLPolyDataReader = vtk.IO.XML.vtkXMLPolyDataReader;
        const vtkActor = vtk.Rendering.Core.vtkActor;
        const vtkMapper = vtk.Rendering.Core.vtkMapper;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;

        // 初始化全屏渲染窗口
        const renderWindowObj = vtkFullScreenRenderWindow.newInstance({
            rootContainer: document.getElementById("container"),
            background: [0.0, 0.0, 0.0]
        });
        const renderer = renderWindowObj.getRenderer();
        const renderWindow = renderWindowObj.getRenderWindow();

        // 创建 Reader 加载 .vtp 文件
        const reader = vtkXMLPolyDataReader.newInstance();

        fetch("http://127.0.0.1:5000/dataset/airfoil_oneslice.vtp")
            .then(res => res.arrayBuffer())
            .then(arrayBuf => {
                // 解析为 PolyData
                reader.parseAsArrayBuffer(arrayBuf);
                const polyData = reader.getOutputData();

                // 设置主标量字段为 'p'
                const pointData = polyData.getPointData();
                if (!pointData.hasArray('p')) {
                    console.error("❌ Error: Missing scalar array 'p'");
                    return;
                }
                pointData.setActiveScalars('p');
                const scalars = pointData.getScalars();
                const [min, max] = scalars.getRange();
                const mid = (min + max) / 2;

                // 创建颜色传输函数（Blue → White → Red）
                const ctf = vtkColorTransferFunction.newInstance();
                ctf.addRGBPoint(min, 0.0, 0.0, 1.0);  // Blue
                ctf.addRGBPoint(mid, 1.0, 1.0, 1.0);  // White
                ctf.addRGBPoint(max, 1.0, 0.0, 0.0);  // Red

                // 创建 Mapper 和 Actor
                const mapper = vtkMapper.newInstance();
                mapper.setInputConnection(reader.getOutputPort());
                mapper.setLookupTable(ctf);
                mapper.setColorByArrayName("p");
                mapper.setScalarRange(min, max);

                const actor = vtkActor.newInstance();
                actor.setMapper(mapper);

                // 材质优化：模拟体渲染的光泽感
                const prop = actor.getProperty();
                prop.setInterpolationToPhong(); // 或者 setInterpolationToGouraud
                prop.setSpecular(0.6);
                prop.setSpecularPower(15);
                prop.setAmbient(0.2);
                prop.setDiffuse(0.8);

                // 添加到渲染器并居中
                renderer.addActor(actor);
                renderer.resetCamera();
                renderWindow.render();
            })
            .catch(err => {
                console.error("❌ 数据加载或处理失败：", err);
            });
    </script>
</body>

</html>