<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>VTK.js Rotor Visualization</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #rendererContainer {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>

<body>
  <!-- Container for the VTK renderer -->
  <div id="rendererContainer"></div>

  <!-- Load vtk.js from CDN -->
  <script src="https://unpkg.com/vtk.js"></script>

  <script>
    // Import necessary modules from vtk.js namespace
    const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
    // const vtkHttpDataSetReader = vtk.IO.Core.vtkHttpDataSetReader;
    const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
    const vtkImageResliceMapper = vtk.Rendering.Core.vtkImageSliceMapper;
    const vtkImageMapper = vtk.Rendering.Core.vtkImageMapper;

    const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
    const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
    const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
    const vtkAxesActor = vtk.Rendering.Core.vtkAxesActor;
    const vtkRenderer = vtk.Rendering.Core.vtkRenderer;

    // Create a full-screen render window and attach it to the DOM container
    const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
      background: [0, 0, 0],
      rootContainer: document.body,
      // containerStyle: { height: '100%' },
      renderWindowSize: { width: window.innerWidth, height: window.innerHeight },
      listenWindowResize: true,
    });

    // Get the renderer and render window
    const renderer = fullScreenRenderer.getRenderer();
    const renderWindow = fullScreenRenderer.getRenderWindow();


    // Load the dataset using vtkHttpDataSetReader
    // const reader = vtkHttpDataSetReader.newInstance({ fetchGzip: true });
    const reader = vtkXMLImageDataReader.newInstance();
    reader.setUrl('http://127.0.0.1:5000/dataset/rotor_simplified.vti').then(() => {
      reader.loadData().then(() => {
        const imageData = reader.getOutputData();
        // Create mapper and slice actor
        const mapper = vtkImageMapper.newInstance();
        const slice = vtkImageSlice.newInstance();

        mapper.setInputData(imageData);
        imageData.getPointData().setActiveScalars('Pressure');


        const dims = imageData.getDimensions();
        const dimY = dims[1]; // Y轴维度
        mapper.setSlice(Math.floor(0.8 * dimY));
        // Add slice to the scene
        slice.setMapper(mapper);
        renderer.addActor(slice);
        // Set up color transfer function for pressure (blue -> white -> red)
        const cfun = vtkColorTransferFunction.newInstance();
        cfun.addRGBPoint(0.0, 0.0, 0.0, 1.0);   // Blue
        cfun.addRGBPoint(0.5, 1.0, 1.0, 1.0);   // White
        cfun.addRGBPoint(1.0, 1.0, 0.0, 0.0);   // Red

        // Set up opacity transfer function (full opacity everywhere)
        const ofun = vtkPiecewiseFunction.newInstance();
        ofun.addPoint(0.0, 1.0);
        ofun.addPoint(1.0, 1.0);

        // Apply color and opacity mappings to the slice property
        const prop = slice.getProperty();
        prop.setRGBTransferFunction(0, cfun);
        prop.setScalarOpacity(0, ofun);
        prop.setInterpolationTypeToNearest(); // Nearest neighbor interpolation for clean slicing

        // Set active scalar to "Pressure"
        // mapper.setInputArrayToProcess(0, 'Pressure');

        // Set slicing mode to Y-axis and position at 80% depth
        // mapper.setSlicingMode(vtkImageMapper.SlicingMode.Y_AXIS);
        // mapper.setSlice(0.8 * 255); // Assuming normalized slice index; adjust based on actual dataset dimensions if needed



        // // Add orientation marker (XYZ axes) to help user understand spatial orientation
        // const axesActor = vtkAxesActor.newInstance();
        // const axesWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget.newInstance({
        //   actor: axesActor,
        //   interactor: renderWindow.getInteractor(),
        // });
        // // axesWidget.setViewportCorner(VtkInteractions.Enums.ViewportCorner.BOTTOM_LEFT);
        // axesWidget.setViewportCorner(vtk.Interaction.Widgets.vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT
        // );

        // axesWidget.setInteractor(renderWindow.getInteractor());
        // axesWidget.setEnabled(true);

        // Initial render
        renderWindow.render();
        renderWindow.render();

      });
    });

  </script>
</body>

</html>