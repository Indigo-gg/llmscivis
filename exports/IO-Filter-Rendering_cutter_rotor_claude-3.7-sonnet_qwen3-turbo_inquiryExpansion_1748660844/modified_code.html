<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotor Slice Visualization</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <script src="https://unpkg.com/vtk.js"></script>
    <script>
        // 引入所需的VTK.js类
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
        // const vtkHttpDataSetReader = vtk.IO.Core.vtkHttpDataSetReader;
        const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
        const vtkImageSliceMapper = vtk.Rendering.Core.vtkImageMapper;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
        const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
        const vtkOrientationMarkerWidget = vtk.Interaction.Widgets.vtkOrientationMarkerWidget;
        const vtkAxesActor = vtk.Rendering.Core.vtkAxesActor;

        // 创建渲染窗口
        const fullScreenRenderWindow = vtkFullScreenRenderWindow.newInstance({
            rootContainer: document.getElementById('container'),
            background: [0.1, 0.1, 0.1]
        });

        const renderWindow = fullScreenRenderWindow.getRenderWindow();
        const renderer = fullScreenRenderWindow.getRenderer();

        // 创建数据读取器
        // const reader = vtkHttpDataSetReader.newInstance({
        //     fetchGzip: true,
        // });

        const reader = vtkXMLImageDataReader.newInstance();
        // 创建切片映射器和切片对象
        const sliceMapper = vtkImageSliceMapper.newInstance();
        const slice = vtkImageSlice.newInstance();
        slice.setMapper(sliceMapper);

        // 创建颜色和不透明度传输函数
        const colorTransferFunction = vtkColorTransferFunction.newInstance();
        const opacityFunction = vtkPiecewiseFunction.newInstance();

        // 设置切片属性
        slice.getProperty().setRGBTransferFunction(0, colorTransferFunction);
        slice.getProperty().setPiecewiseFunction(0, opacityFunction);
        slice.getProperty().setInterpolationTypeToLinear();

        // 加载数据
        reader.setUrl('http://127.0.0.1:5000/dataset/rotor_simplified.vti')
            .then(() => {
                reader.loadData().then(() => {
                    // 获取数据
                    const data = reader.getOutputData();

                    // 设置"Pressure"为活动标量
                    const pressureArray = data.getPointData().getArrayByName('Pressure');
                    if (pressureArray) {
                        data.getPointData().setActiveScalars('Pressure');

                        // 获取压力值范围
                        const pressureRange = pressureArray.getRange();
                        const min = pressureRange[0];
                        const max = pressureRange[1];

                        console.log('Pressure range:', min, max);

                        // 设置颜色映射（蓝-白-红渐变）
                        colorTransferFunction.addRGBPoint(min, 0.0, 0.0, 1.0);  // 蓝色
                        colorTransferFunction.addRGBPoint((min + max) / 2, 1.0, 1.0, 1.0);  // 白色
                        colorTransferFunction.addRGBPoint(max, 1.0, 0.0, 0.0);  // 红色

                        // 设置不透明度（完全不透明）
                        opacityFunction.addPoint(min, 1.0);
                        opacityFunction.addPoint(max, 1.0);
                    }

                    // 设置切片映射器
                    sliceMapper.setInputData(data);

                    // 设置Y轴切片，位于80%深度
                    const dimensions = data.getDimensions();
                    const ySlicePosition = Math.floor(dimensions[1] * 0.8);

                    sliceMapper.setSlicingMode(1);  // Y轴切片 (0=X, 1=Y, 2=Z)
                    sliceMapper.setSlice(ySlicePosition);

                    // 添加切片到渲染器
                    renderer.addActor(slice);

                    // 重置相机以适应数据
                    renderer.resetCamera();
                    renderWindow.render();

                    // 添加方向标记
                    const axes = vtkAxesActor.newInstance();
                    const orientationWidget = vtkOrientationMarkerWidget.newInstance({
                        actor: axes,
                        interactor: renderWindow.getInteractor()
                    });
                    orientationWidget.setEnabled(true);
                    orientationWidget.setViewportCorner(
                        vtkOrientationMarkerWidget.Corners.BOTTOM_RIGHT
                    );
                    orientationWidget.setViewportSize(0.15);
                    orientationWidget.setMinPixelSize(100);
                    orientationWidget.setMaxPixelSize(300);
                });
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    </script>
</body>

</html>