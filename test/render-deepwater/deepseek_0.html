<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Rendering with vtk.js</title>
    <script src="https://unpkg.com/vtk.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #renderWindowContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="renderWindowContainer"></div>
    <script>
        // Load the vtk.js library and set up the visualization pipeline
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkXMLImageDataReader = vtk.IO.XML.vtkXMLImageDataReader;
        const vtkVolume = vtk.Rendering.Core.vtkVolume;
        const vtkVolumeMapper = vtk.Rendering.Core.vtkVolumeMapper;
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
        // const vtkPiecewiseFunction = vtk.Rendering.Core.vtkPiecewiseFunction;
        const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
        const vtkRenderer = vtk.Rendering.Core.vtkRenderer;
        // Create a full-screen render window
        const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
            rootContainer: document.getElementById('renderWindowContainer'),
            background: [0, 0, 0],
        });
        const renderer = fullScreenRenderer.getRenderer();
        const renderWindow = fullScreenRenderer.getRenderWindow();

        // Load the dataset from the specified URL
        // const reader = vtkHttpDataSetReader.newInstance({ fetchGzip: true });
        const reader = vtkXMLImageDataReader.newInstance();
        reader.setUrl('http://127.0.0.1:5000/dataset/deepwater.vti').then(() => {

            const imageData = reader.getOutputData(0);
            //console.log(imageData.toJSON())
            //set active scalar

            imageData.getPointData().setActiveScalars('v02');
            imageData.setSpacing(0.02, 0.02, 0.02);
            console.log(imageData.getPointData().getScalars().getName());

            // Create a volume mapper
            const mapper = vtkVolumeMapper.newInstance()
            // mapper.setInputConnection(reader.getOutputPort());
            mapper.setInputData(imageData);

            // Create a volume and set the mapper
            const volume = vtkVolume.newInstance();
            volume.setMapper(mapper);

            // Create a color transfer function for the scalar field "v02"
            const colorTransferFunction = vtkColorTransferFunction.newInstance();
            colorTransferFunction.addRGBPoint(0, 0, 0, 1); // Blue
            colorTransferFunction.addRGBPoint(0.5, 1, 1, 1); // White
            colorTransferFunction.addRGBPoint(1, 1, 0, 0); // Red

            // Create a piecewise function for opacity (transparency)
            const piecewiseFunction = vtkPiecewiseFunction.newInstance();
            piecewiseFunction.addPoint(0, 0.0); // Fully transparent
            piecewiseFunction.addPoint(0.5, 0.5); // Semi-transparent
            piecewiseFunction.addPoint(1, 1.0); // Fully opaque

            // Set the color and opacity functions to the volume property
            const volumeProperty = volume.getProperty();
            volumeProperty.setRGBTransferFunction(0, colorTransferFunction);
            volumeProperty.setScalarOpacity(0, piecewiseFunction);
            volumeProperty.setInterpolationTypeToLinear();
            volumeProperty.setShade(true);
            volumeProperty.setAmbient(0.2);
            volumeProperty.setDiffuse(0.7);
            volumeProperty.setSpecular(0.3);
            volumeProperty.setSpecularPower(8.0);

            // Add the volume to the renderer
            renderer.addVolume(volume);

            // Reset the camera and render the scene
            renderer.resetCamera();
            renderWindow.render();
        });
    </script>
</body>

</html>