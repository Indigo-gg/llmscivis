<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Rendering with vtk.js</title>
    <style>
        #renderer {
            width: 100%;
            height: 600px;
            background-color: #333;
        }
    </style>
</head>

<body>
    <div id="renderer"></div>
    <script src="https://unpkg.com/vtk.js"></script>
    <!-- <script src="https://unpkg.com/vtk.js/Sources/IO/Core/DataAccessHelper/LiteHttpDataAccessHelper.js"></script> -->
    <script>
        // Import necessary vtk.js modules
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
        const vtkVolume = vtk.Rendering.Core.vtkVolume;
        const vtkVolumeMapper = vtk.Rendering.Core.vtkVolumeMapper;

        // Initialize the full-screen render window
        const fullScreenRenderWindow = vtkFullScreenRenderWindow.newInstance({
            background: [0, 0, 0],
        });
        const renderWindow = fullScreenRenderWindow.getRenderWindow();
        const renderer = fullScreenRenderWindow.getRenderer();

        // Load the volume data from the specified URL
        const dataURL = 'http://127.0.0.1:5000/dataset/deepwater.vti';
        const reader = vtk.IO.XML.vtkXMLImageDataReader.newInstance();

        // vtk.IO.Core.DataAccessHelper.LiteHttpDataAccessHelper.fetchBinary(dataURL).then(binary => {
        reader.setUrl(dataURL).then(() => {
            // reader.parseAsArrayBuffer(binary);
            const imageData = reader.getOutputData(0);

            imageData.getPointData().setActiveScalars('v02');
            imageData.setSpacing(0.02, 0.02, 0.02);
            // Create the volume mapper and set the input data
            const volumeMapper = vtkVolumeMapper.newInstance();
            volumeMapper.setInputData(imageData);

            // Create the volume actor and set the mapper
            const volumeActor = vtkVolume.newInstance();
            volumeActor.setMapper(volumeMapper);

            // Create a color transfer function for the scalar field "v02"
            const colorTransferFunction = vtkColorTransferFunction.newInstance();
            colorTransferFunction.addRGBPoint(0.0, 0.0, 0.0, 1.0); // Blue
            colorTransferFunction.addRGBPoint(0.5, 1.0, 1.0, 1.0); // White
            colorTransferFunction.addRGBPoint(1.0, 1.0, 0.0, 0.0); // Red

            // Create a piecewise function for transparency
            const piecewiseFunction = vtkPiecewiseFunction.newInstance();
            piecewiseFunction.addPoint(0.0, 0.0);
            piecewiseFunction.addPoint(0.5, 0.5);
            piecewiseFunction.addPoint(1.0, 1.0);

            // Set the color and opacity functions to the volume property
            volumeActor.getProperty().setRGBTransferFunction(0, colorTransferFunction);
            volumeActor.getProperty().setScalarOpacity(0, piecewiseFunction);

            // Enable physically-based lighting
            volumeActor.getProperty().setAmbient(0.2);
            volumeActor.getProperty().setDiffuse(0.7);
            volumeActor.getProperty().setSpecular(0.3);
            volumeActor.getProperty().setSpecularPower(8.0);

            // Add the volume actor to the renderer
            renderer.addVolume(volumeActor);

            // Reset the camera and render the scene
            renderer.resetCamera();
            renderWindow.render();
        }).catch(error => {
            console.error('Error loading volume data:', error);
        });
    </script>
</body>

</html>